/* qmaxima_test.mac - Pruebas automÃ¡ticas corregidas */

qmaxima_run_test() := block(
    [zero, psi0, psi1, psi_bell, file_lines, found_h, found_cx, line],
    
    print("ğŸ§ª Iniciando prueba de qmaxima..."),
    
    /* === 1. Cargar dependencias === */
    if not load("linearalgebra") then (
        print("âŒ ERROR: No se pudo cargar linearalgebra"),
        return(false)
    ),
    
    if not load("qmaxima") then (
        print("âŒ ERROR: No se pudo cargar qmaxima"),
        return(false)
    ),
    
    print("âœ… Dependencias cargadas."),
    
    /* === 2. Reiniciar estado global === */
    quantum_ops : [],
    
    /* === 3. Definir estado base === */
    zero : matrix([1],[0]),
    psi0 : kronecker_product(zero, zero),
    
    if not matrixp(psi0) then (
        print("âŒ ERROR: psi0 no es una matriz"),
        return(false)
    ),
    
    if length(psi0) # 4 then (
        print("âŒ ERROR: psi0 no tiene tamaÃ±o 4"),
        return(false)
    ),
    
    print("âœ… Estado inicial |00> vÃ¡lido."),
    
    /* === 4. Aplicar puertas === */
    psi1 : h(0, psi0),
    if length(quantum_ops) # 1 then (
        print("âŒ ERROR: h(0, psi0) no registrÃ³ operaciÃ³n"),
        print("quantum_ops =", quantum_ops),
        return(false)
    ),
    
    psi_bell : cx(0, 1, psi1),
    if length(quantum_ops) # 2 then (
        print("âŒ ERROR: cx(0,1,psi1) no registrÃ³ operaciÃ³n"),
        print("quantum_ops =", quantum_ops),
        return(false)
    ),
    
    print("âœ… Puertas registradas correctamente."),
    
    /* === 5. Parsear operaciones === */
    if not qmaxima_parse() then (
        print("âŒ ERROR: qmaxima_parse() fallÃ³"),
        return(false)
    ),
    
    if qmaxima_num_qubits # 2 then (
        print("âŒ ERROR: NÃºmero de qubits incorrecto:", qmaxima_num_qubits),
        return(false)
    ),
    
    print("âœ… Parseo correcto."),
    
    /* === 6. Generar cÃ³digo Qiskit === */
    if not qmaxima_draw() then (
        print("âŒ ERROR: qmaxima_draw() fallÃ³"),
        return(false)
    ),
    
    /* === 7. Verificar cÃ³digo Qiskit === */
    file_lines : read_list("/tmp/qmaxima_circuit.py"),
    found_h : false,
    found_cx : false,
    for line in file_lines do (
        if ssearch("qc.h(0)", line) # false then found_h : true,
        if ssearch("qc.cx(0,1)", line) # false then found_cx : true
    ),
    
    if not found_h then (
        print("âŒ ERROR: CÃ³digo Qiskit no contiene qc.h(0)"),
        return(false)
    ),
    
    if not found_cx then (
        print("âŒ ERROR: CÃ³digo Qiskit no contiene qc.cx(0,1)"),
        return(false)
    ),
    
    print("âœ… CÃ³digo Qiskit generado correctamente."),
    
    /* === 8. Resultado final === */
    print("ğŸ‰ Â¡Todas las pruebas pasaron!"),
    print("   qmaxima estÃ¡ listo para usar."),
    return(true)
)$

/* Ejecutar prueba al cargar */
qmaxima_run_test()$
